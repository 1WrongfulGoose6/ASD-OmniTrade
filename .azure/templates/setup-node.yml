# Shared Node.js setup template for consistent environment across all jobs
steps:
  - task: UseNode@1
    inputs:
      version: $(nodeVersion)
    displayName: 'Use Node.js $(nodeVersion)'

  - task: Cache@2
    displayName: 'Cache node_modules'
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      path: 'node_modules'
      cacheHitVar: 'NPM_CACHE_RESTORED'

  - script: npm ci
    displayName: 'Install Dependencies'
    condition: ne(variables.NPM_CACHE_RESTORED, 'true')

  - script: |
      echo "FINNHUB_API_KEY=d313k2hr01qnu2r0cfkgd313k2hr01qnu2r0cfl0" > .env
      echo 'DATABASE_URL="file:./prisma/test.db"' >> .env
      echo 'NODE_ENV="test"' >> .env
    displayName: 'Set up CI Environment Variables'

  - task: Cache@2
    displayName: 'Cache Prisma client'
    inputs:
      key: 'prisma | "$(Agent.OS)" | prisma/schema.ci.prisma'
      path: 'node_modules/.prisma'

  - script: npx prisma generate --schema=prisma/schema.ci.prisma
    displayName: 'Generate Prisma Client (SQLite for CI)'

  - script: npx prisma db push --schema=prisma/schema.ci.prisma
    displayName: 'Set up Test Database Schema (SQLite)'